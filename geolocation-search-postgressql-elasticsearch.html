<!DOCTYPE html>
<html itemtype="http://schema.org/Blog" lang="en"><head><title>Troubleshooting for using logstash feeds geolocation data to Elasticsearch</title><meta charset="utf-8"><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible"><meta content="width=device-width, initial-scale=1.0, user-scalable=no" name="viewport"><link href="/favicon.ico" rel="shortcut icon"><link href="/atom.xml" rel="alternate" title="Atom feed" type="application/atom+xml"><link href="/css/app.css" rel="stylesheet" type="text/css"><link href="https://fonts.googleapis.com/css?family=Source%2BCode%2BPro%7CArvo%3A400%2C700%7CDroid%2BSerif%3A400%2C400italic%2C700" rel="stylesheet" type="text/css"><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/highlight.min.js" type="text/javascript"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/languages/clojure.min.js" type="text/javascript"></script><script>hljs.initHighlightingOnLoad();</script><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-94017226-1', 'auto');
  ga('send', 'pageview');
</script><meta content="/images/ub.png" property="og:image"><meta content="Troubleshooting for using logstash feeds geolocation data to Elasticsearch" property="og:title"><meta content="Elasticsearch PostgreSQL integration" property="og:description"></head><body><div class="header"><nav class="container" role="navigation"><div class="site"><a href="/"><img src="/images/ub_blog.svg"></a></div><ul><li><a href="/tags">Tags</a></li><li><a href="/about.html">About</a></li></ul></nav></div><div class="main"><div class="container post"><h1>Troubleshooting for using logstash feeds geolocation data to Elasticsearch</h1><div><h4><a href="#troubleshooting-for-using-logstash-feeds-geolocation-data-to-elasticsearch" id="troubleshooting-for-using-logstash-feeds-geolocation-data-to-elasticsearch"></a>Troubleshooting for using logstash feeds geolocation data to Elasticsearch</h4>
<p>Around 4 years ago I started to use mongodb for my place search side project, actually I prefer to 2d geolocation search feature of mongodb and mongodb is very good, but when I want to provide fulltext search as well, seems mongo is not good at fulltext search especially multiple language supporting. So I was thought migrate to elasticsearch solution...emm... yes my another tech debt.</p>
<p>The idea is quite simple which is store all places info as meta data in postgresql and then through logstash synchronize to elasticsearch. Elasticsearch will be readonly datasource and be provided geolocation &amp; fulltext search.</p>
<p><a href="https://www.elastic.co/products/logstash">Logstash</a> is really powerful &amp; easy tool to synchronize data to elasticsearch. We only need to define a configuration file to tell logstash where is input &amp; output then it can work alone. Basically logstash will be mapping all database table fields to elasticsearch.  But since I alreay have migrated data from mongodb to postgresql so lantitude &amp; longitude are normal columns in my database, it's not correct geo_point type in elasticsearch. Fortunately logstash has <strong>filter</strong> feature can be defined with input&amp;output in configuration file.</p>
<p>The basic feature of <strong>filter</strong> is for converting field data format, creating new field and remove unnecessary fields. For my case I need to convert latitude &amp; longitude columns to geo_point type of elasticsearch and remove location_lat &amp; location_lng fields. Acutally I was stuck on one issue which is before feeding data to elasticsearch we have to create index first otherwise elasticsearch will not handle location as geo_pooint.</p>
<p>create index payload data sample:</p>
<pre><code class="language-json">{
    &quot;settings&quot;:{
        &quot;number_of_shards&quot;:1
    },
    &quot;mappings&quot;:{
        &quot;test&quot;:{
            &quot;properties&quot;:{             
                &quot;location&quot;:{
                    &quot;type&quot;:&quot;geo_point&quot;
                }
            }
        }
    }
}
</code></pre>
<p>logstash filter sample:</p>
<pre><code class="language-conf">filter {
    mutate {
        add_field =&gt; { &quot;[location][lat]&quot; =&gt; &quot;%{location_lat}&quot; }
        add_field =&gt; { &quot;[location][lon]&quot; =&gt; &quot;%{location_lng}&quot; }
        remove_field =&gt; [&quot;location_lat&quot;, &quot;location_lng&quot;]
    }
    mutate {
        convert =&gt; {
            &quot;[location][lat]&quot; =&gt; &quot;float&quot;
            &quot;[location][lon]&quot; =&gt; &quot;float&quot;
        }
    }
}
</code></pre>
<p>geo_point data strucutre:</p>
<pre><code class="language-json">{
    &quot;location&quot;: {
        &quot;lat&quot;: 42.286681,
        &quot;lon&quot;: 119.000181
    }
}
</code></pre>
<p>Elasticsearch allows latitude between -90 ~ 90, longitude between -180 ~ 180 see (<a href="https://en.wikipedia.org/wiki/Geohash">Geohash</a>) definition. So if you have geolocation data is not in this range should think about your data maybe is wrong. I was stuck in this issue with lots of error like <code>java.lang.IllegalArgumentException: illegal latitude value [-95.66912769999999]</code> .</p>
<p>Finally I can query geolocation:</p>
<pre><code class="language-curl">curl -X GET &quot;localhost:9200/places/_search&quot; -H 'Content-Type: application/json' -d'
{
    &quot;query&quot;: {
        &quot;bool&quot; : {
            &quot;must&quot; : {
                &quot;match_all&quot; : {}
            },
            &quot;filter&quot; : {
                &quot;geo_distance&quot; : {
                    &quot;distance&quot; : &quot;2km&quot;,
                    &quot;location&quot; : {
                        &quot;lat&quot; : 42.285559,
                        &quot;lon&quot; : 119.004589
                    }
                }
            }
        }
    }
}
'
</code></pre>
<p>My last quirement from elasticsearch is fulltext search at least supporting english and chinese. I googled a lots of articles how to support multiple anaylzer for different langugage in one field but seems those articles are not work for <strong>6.2.4</strong> version. So I want to record instruction hope can help people who wants to do the same thing.</p>
<p>For supporting chinese I follow the suggestion to use <a href="https://github.com/medcl/elasticsearch-analysis-ik">IK Analysis</a> . To install IK analysis plugin we can use <code>./bin/elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v6.2.4/elasticsearch-analysis-ik-6.2.4.zip</code> command to install in elasticsearch. After that we need to create index to support multiple analyzer. E.g for city field we want to chinese uses ik analyzer and english uses english analyzer.</p>
<pre><code>{
    &quot;settings&quot;:{
        &quot;number_of_shards&quot;:1
    },
    &quot;mappings&quot;:{
        &quot;place&quot;:{
            &quot;properties&quot;:{
                &quot;city&quot;:{
                    &quot;type&quot;:&quot;text&quot;,
                    &quot;fields&quot;:{
                        &quot;cn&quot;:{
                            &quot;type&quot;:&quot;text&quot;,
                            &quot;analyzer&quot;:&quot;ik_smart&quot;
                        },
                        &quot;en&quot;:{
                            &quot;type&quot;:&quot;text&quot;,
                            &quot;analyzer&quot;:&quot;english&quot;
                        }
                    }
                }
            }
        }
    }
}
</code></pre>
<p>Right now we have created index for one field supporting multiple analyzer so we can use <strong>multi_match</strong> search feature to verify whether it's working.</p>
<pre><code>curl -X POST &quot;localhost:9200/places/_search&quot; -H 'Content-Type: application/json' -d'
{
  &quot;query&quot;: {
    &quot;multi_match&quot;: {
      &quot;type&quot;:     &quot;most_fields&quot;, 
      &quot;query&quot;:    &quot;天津大连&quot;,
      &quot;fields&quot;: [ &quot;city&quot; ]
    }
  }
}
'
</code></pre>
<p>We also can use <strong>_analyze</strong> API to verify whether the analyzer is working.</p>
<pre><code>curl -X GET &quot;localhost:9200/places/_analyze&quot; -H 'Content-Type: application/json' -d'
{
  &quot;tokenizer&quot;: &quot;ik_smart&quot;,
  &quot;text&quot;:     &quot;天津大连&quot;
}
'
</code></pre>
<p>Conclusion:</p>
<p>This is a very nice weekend for me because I pay back my another tech debt :fist_oncoming: , moving forward still need to think how to put everthing to jenkins maybe use docker. Hope it's not another debt :joy:</p>
</div><aside class="comments"><div><div id="disqus_thread"></div><script type="text/javascript">var disqus_config = function () {
            //this.page.url = 'http://unclebean.github.io/hugh/';
            this.page.identifier = '/geolocation-search-postgressql-elasticsearch.html';
        };
        (function() { 
        var d = document, s = d.createElement('script');
        s.src = 'https://hj1984.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
        })();</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></noscript></div></aside></div></div><footer class="footer"><div class="container"><ul><li><a href="https://github.com/unclebean">github.com/unclebean</a></li></ul></div></footer><script>console.log("startup...");</script></body></html>