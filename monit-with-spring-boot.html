<!DOCTYPE html>
<html itemtype="http://schema.org/Blog" lang="en"><head><title>Hou Jian's Blog</title><meta charset="utf-8"><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible"><meta content="width=device-width, initial-scale=1.0, user-scalable=no" name="viewport"><link href="/favicon.ico" rel="shortcut icon"><link href="/atom.xml" rel="alternate" title="Atom feed" type="application/atom+xml"><link href="/css/app.css" rel="stylesheet" type="text/css"><link href="http://fonts.googleapis.com/css?family=Source%2BCode%2BPro%7CArvo%3A400%2C700%7CDroid%2BSerif%3A400%2C400italic%2C700" rel="stylesheet" type="text/css"><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/highlight.min.js" type="text/javascript"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/languages/clojure.min.js" type="text/javascript"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="header"><nav class="container" role="navigation"><div class="site"><a href="/"><img src="./images/ub_blog.svg"></a></div><ul><li><a href="/tags">Tags</a></li><li><a href="/about.html">About</a></li></ul></nav></div><div class="main"><div class="container post"><h1>Using Monit with Spring boot embedded tomcat</h1><div><p><a href="https://mmonit.com/monit/">Monit</a> is an open source process monitor &amp; error recovery tool. I have a small VPS on DigitalOcean only has 512MB memory, my spring-boot app often due to out of memory to stop. So I plan to use Monit to monitor spring-boot process and restart it. I found a good <a href="http://www.tecmint.com/how-to-install-and-setup-monit-linux-process-and-services-monitoring-program/">article</a> regarding how to install/using Monit. I learn how to use Monit to monitor a service such as “Nginx &amp; Mysql”, but I still need to monitor my embedded tomcat WAR file meanwhile start program from my user.</p>
<p>So I create a shell script to handle startup my WAR file then record PID into pidfile so that I stop process with the pidfile.</p>
<p>Shell script template from <a href="https://stackoverflow.com/questions/23454344/use-monit-monitor-a-python-program/25170143#25170143">Stack Overflow</a></p>
<pre><code class="language-bash">    #!/bin/bash
    PIDFILE=app.pid
    case $1 in
    start)
    # Launch your program as a detached process
    java -Xmx280m -Xss80m -jar app.war -server.port=8080 — server.tomcat.max-threads=20 &gt; startup.log 2&gt;&amp;1 &amp;
    # Get its PID and store it
    echo $! &gt; ${PIDFILE}
    ;;
    stop)
    kill -15 `cat ${PIDFILE}`
    # Now that it’s killed, don’t forget to remove the PID file
    rm ${PIDFILE}
    ;;
</code></pre>
<p>The script is working very well when I execute it individually. But I still can’t through Monit to start my app. The root cause is that Monit uses “root” to execute script but my WAR file does’t belong to “root”. For fixing that I need to edit <strong>“/etc/monit/monitrc”</strong> configuration file like this:</p>
<pre><code>    check process app with pidfile /home/dev/app/app.pid
    start program = “/bin/su — dev -c ‘cd /home/dev/app; ./startup.sh start’” timeout 100 seconds
    stop program = “/bin/su — dev -c ‘cd /home/dev/app; ./startup.sh stop’”
    if failed host 127.0.0.1 port 8080 then restart
    if 5 restarts within 5 cycles then timeout
</code></pre>
<blockquote>
<p>/bin/su — dev will use dev to execute my shell.</p>
</blockquote>
</div><aside class="comments"><div><div id="disqus_thread"></div><script type="text/javascript">var disqus_config = function () {
            //this.page.url = 'http://unclebean.github.io/hugh/';
            this.page.identifier = '/monit-with-spring-boot.html';
        };
        (function() { 
        var d = document, s = d.createElement('script');
        s.src = 'https://hj1984.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
        })();</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></noscript></div></aside></div></div><footer class="footer"><div class="container"><ul><li><a href="https://github.com/unclebean">github.com/unclebean</a></li></ul></div></footer><script>console.log("startup...");</script></body></html>