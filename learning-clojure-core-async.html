<!DOCTYPE html>
<html itemtype="http://schema.org/Blog" lang="en"><head><title>Handle multiple http requests with core.async part-1</title><meta charset="utf-8"><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible"><meta content="width=device-width, initial-scale=1.0, user-scalable=no" name="viewport"><link href="/favicon.ico" rel="shortcut icon"><link href="/atom.xml" rel="alternate" title="Atom feed" type="application/atom+xml"><link href="/css/app.css" rel="stylesheet" type="text/css"><link href="https://fonts.googleapis.com/css?family=Source%2BCode%2BPro%7CArvo%3A400%2C700%7CDroid%2BSerif%3A400%2C400italic%2C700" rel="stylesheet" type="text/css"><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/highlight.min.js" type="text/javascript"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/languages/clojure.min.js" type="text/javascript"></script><script>hljs.initHighlightingOnLoad();</script><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-94017226-1', 'auto');
  ga('send', 'pageview');
</script></head><body><div class="header"><nav class="container" role="navigation"><div class="site"><a href="/"><img src="/images/ub_blog.svg"></a></div><ul><li><a href="/tags">Tags</a></li><li><a href="/about.html">About</a></li></ul></nav></div><div class="main"><div class="container post"><h1>Handle multiple http requests with core.async part-1</h1><div><h4><a href="#handle-multiple-http-requests-with-coreasync-part-1" id="handle-multiple-http-requests-with-coreasync-part-1"></a>Handle multiple http requests with core.async part-1</h4>
<p>I'm starting to learn core.async library. It's very powerful asynchronized library for clojure. I can find a lot of very good articles for it. So my post only wnat to talk about a scenario:</p>
<blockquote>
<p>read URL list file, one by one to request each URL, once the request complete we put the response in the channel for next step processing.</p>
</blockquote>
<p>My doubt is we should use only one channel for all response or we should create multi channels for each response. Acutally I also read <a href="https://pragprog.com/book/pb7con/seven-concurrency-models-in-seven-weeks">Seven Concurrency Models in Seven Weeks</a> The question from this book, the author mentioned a function to handle wikipedia xml dump.</p>
<p>To answer myself I implemented the ways &amp; mintor performance from <a href="https://visualvm.java.net">VirtualVM</a></p>
<blockquote>
<p>I will use some basic functions from core.async to implement feature.</p>
<p><strong>(go)</strong> for creation block to handle parking &quot;read&quot; &amp; &quot;write&quot; message in channel.</p>
<p><strong>(go-loop)</strong> each go block only can handle one times read or write. so core.async provides go-loop marco to run a loop for multi times message reading or writing.</p>
<p><strong>&lt;!</strong> read message from channel, it will not block running thread.</p>
<p><strong>&gt;!</strong> write message to channel with non blocking.</p>
<p><strong>put!</strong> write message to channel, put! function no need work in go block.</p>
</blockquote>
<p><strong>single channel version</strong></p>
<pre><code>(ns playasync.core
  (:require [clojure.core.async :as async
             :refer [&gt;! &lt;! &gt;!! &lt;!! go chan buffer close! alts!! go-loop merge]]
            [playasync.http-call :as http-call]
            [clojure.java.io :as io]
            )
  (:gen-class))

(defn -main
  [feeds-path &amp; args]
  (with-open [feeds-io (io/reader feeds-path)]
    (let [ch (chan)
          feeds (line-seq feeds-io)]
      (doall
        (map (fn [url] (http-call/get-rss-v2 ch url)) feeds))
      (go-loop []
        (&lt;! ch)
        (recur)))
))
</code></pre>
<p>This implementation pass a channel to <strong>http-call/get-rss-v2</strong> function, map function will call this function for each URL, once the request complete will use this channel and put response in it then <strong>go-loop</strong> will read response from the channel.</p>
<p><strong>Multi channels version</strong></p>
<pre><code>(ns playasync.core
  (:require [clojure.core.async :as async
             :refer [&gt;! &lt;! &gt;!! &lt;!! go chan buffer close! alts!! go-loop merge]]
            [playasync.http-call :as http-call]
            [clojure.java.io :as io]
            )
  (:gen-class))

(defn -main
  [feeds-path &amp; args]
  (with-open [feeds-io (io/reader feeds-path)]
    (let [feeds (line-seq feeds-io)]
      (doall
        (for [feed feeds]
          (go (&lt;! (http-call/get-rss feed)))
          )
        )
    )
  ))
</code></pre>
<p><strong>http-call/get-rss</strong> function will create individual channel for each http request then return the channel for caller, once the request complete will send message to the channel.</p>
<p>Let's compare two version execution time:</p>
<p><strong>version 1 single channel</strong></p>
<p><img src="https://unclebean.github.io/images/clojure-async-single-channel.png" alt="single channel" /></p>
<p><strong>version 2 multiple channels</strong></p>
<p><img src="https://unclebean.github.io/images/clojure-async-single-channel.png" alt="multiple channels" /></p>
<p>For now we can see seems we should use <strong>single channel</strong> version for this function, but I will continue to explore the right way...</p>
</div><aside class="comments"><div><div id="disqus_thread"></div><script type="text/javascript">var disqus_config = function () {
            //this.page.url = 'http://unclebean.github.io/hugh/';
            this.page.identifier = '/learning-clojure-core-async.html';
        };
        (function() { 
        var d = document, s = d.createElement('script');
        s.src = 'https://hj1984.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
        })();</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></noscript></div></aside></div></div><footer class="footer"><div class="container"><ul><li><a href="https://github.com/unclebean">github.com/unclebean</a></li></ul></div></footer><script>console.log("startup...");</script></body></html>